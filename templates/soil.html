<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Soil Analysis | HelioRoots AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="{{ url_for('static', filename='js/speech.js') }}"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .agri-bg { background: linear-gradient(rgba(2, 6, 23, 0.9), rgba(2, 6, 23, 0.9)), url('https://images.unsplash.com/photo-1592924357228-91a4daadcfea?w=1600'); background-size: cover; background-attachment: fixed; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        #image-preview { max-height: 100%; max-width: 100%; object-fit: contain; }
        /* Scanning Animation Effect */
        .scan-line { width: 100%; height: 4px; background: #10b981; position: absolute; top: 0; left: 0; box-shadow: 0 0 15px #10b981; animation: scan 2s infinite ease-in-out; display: none; z-index: 20; }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }
    </style>
</head>
<body class="min-h-screen text-slate-100 p-8 agri-bg">
    <div class="max-w-4xl mx-auto text-center">
        <h1 class="text-5xl font-black text-emerald-400 mb-8 italic uppercase">AI Soil Analysis</h1>
        
        <div class="glass p-10 rounded-3xl shadow-2xl mb-8">
            <div id="soil-visual" class="w-full h-64 bg-slate-800 rounded-2xl mb-6 flex flex-col items-center justify-center border-2 border-dashed border-emerald-500/30 overflow-hidden relative">
                <div id="scanLine" class="scan-line"></div>
                <img id="image-preview" src="#" alt="Soil Preview" class="hidden rounded-2xl" />
                
                <div id="upload-prompt" class="flex flex-col items-center">
                    <i class="fas fa-microscope text-6xl text-emerald-500/20 mb-4"></i>
                    <p class="text-slate-400 text-sm">Upload or capture a soil sample for AI verification</p>
                </div>

                <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden" onchange="previewImage(this)">
                <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="previewImage(this)">
            </div>

            <div class="flex gap-4 justify-center mb-8">
                <button onclick="document.getElementById('cameraInput').click()" class="bg-emerald-600/20 border border-emerald-500/30 px-6 py-3 rounded-2xl text-xs font-black uppercase tracking-widest hover:bg-emerald-500/30 transition-all">
                    <i class="fas fa-camera mr-2"></i> Use Camera
                </button>
                <button onclick="document.getElementById('fileInput').click()" class="bg-slate-700/50 border border-slate-600 px-6 py-3 rounded-2xl text-xs font-black uppercase tracking-widest hover:bg-slate-600 transition-all">
                    <i class="fas fa-file-upload mr-2"></i> Upload File
                </button>
            </div>
            
            <h2 id="soil-type-name" class="text-3xl font-bold text-white mb-2 uppercase tracking-widest italic">Syncing with Regional Data...</h2>
            <p id="district-tag" class="text-emerald-500 font-bold uppercase text-xs tracking-widest mb-6">Database Sync Active</p>
            
            <div class="grid grid-cols-2 gap-4 text-left">
                <div class="bg-white/5 p-4 rounded-2xl border border-white/10">
                    <p class="text-[10px] text-slate-500 uppercase font-bold">Regional Rainfall</p>
                    <p id="rain-val" class="text-xl font-black">-- mm</p>
                </div>
                <div class="bg-white/5 p-4 rounded-2xl border border-white/10">
                    <p class="text-[10px] text-slate-500 uppercase font-bold">Avg Temperature</p>
                    <p id="temp-val" class="text-xl font-black">-- °C</p>
                </div>
            </div>
        </div>

       <button onclick="window.location.href='/simulation'" 
        class="bg-emerald-500 text-slate-950 font-black px-12 py-4 rounded-2xl text-lg hover:scale-105 transition-transform">
    START SMART SIMULATION <i class="fas fa-bolt ml-2"></i>
</button>
    </div>

   <script>
    const lang = localStorage.getItem('selectedLang') || 'en-IN';
    const district = localStorage.getItem('userDistrict') || 'Mandya';
    const crop = localStorage.getItem('selectedCrop') || 'Paddy';

    // 1. Initial Voice Greeting
    window.onload = () => {
        const welcomeMsg = lang === 'kn-IN' ? 
            "ದಯವಿಟ್ಟು ಮಣ್ಣಿನ ಮಾದರಿಯನ್ನು ಅಪ್‌ಲೋಡ್ ಮಾಡಿ ಅಥವಾ ಫೋಟೋ ತೆಗೆಯಿರಿ." : 
            "Please upload or capture your soil sample for AI verification.";
        if(typeof speak === 'function') speak(welcomeMsg, lang);
        
        // Update UI labels immediately
        document.getElementById('district-tag').innerText = `${district} Regional Profile`;
    };

    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('image-preview');
                const prompt = document.getElementById('upload-prompt');
                const scanLine = document.getElementById('scanLine');
                
                preview.src = e.target.result;
                preview.classList.remove('hidden');
                prompt.classList.add('hidden');
                scanLine.style.display = 'block';
                
                // 2. Scan Voice Alert
                const msg = lang === 'kn-IN' ? 
                    "ಮಣ್ಣಿನ ಮಾದರಿಯನ್ನು ಸ್ವೀಕರಿಸಲಾಗಿದೆ. ಸ್ಕ್ಯಾನಿಂಗ್ ಪ್ರಾರಂಭಿಸಲಾಗುತ್ತಿದೆ." : 
                    "Soil sample received. Starting high-precision scan.";
                if(typeof speak === 'function') speak(msg, lang);

                setTimeout(runAnalysis, 3000);
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function runAnalysis() {
        const formData = new FormData();
        formData.append('crop', crop);
        formData.append('district', district);
        formData.append('language', lang);

        try {
            // Fetching suitability data from your SQL database
            const response = await fetch('/api/analyze', { method: 'POST', body: formData });
            const data = await response.json();
            
            document.getElementById('scanLine').style.display = 'none';
            document.getElementById('soil-type-name').innerText = "Analysis Complete";
            
            // 3. Display rainfall/temp from SQL Region table
            if(data.rainfall) document.getElementById('rain-val').innerText = `${data.rainfall} mm`;
            if(data.temp) document.getElementById('temp-val').innerText = `${data.temp} °C`;

            // 4. Suitability logic based on AI response
            // AI advice now includes specific soil suitability from the DB
            const suitabilityMsg = data.advice;
            
            if(typeof speak === 'function') speak(suitabilityMsg, lang);

        } catch (e) {
            console.error("Analysis Failed", e);
            document.getElementById('soil-type-name').innerText = "Sync Error";
            const errorMsg = lang === 'kn-IN' ? "ದೋಷ ಸಂಭವಿಸಿದೆ. ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ." : "Sync error. Please try again.";
            if(typeof speak === 'function') speak(errorMsg, lang);
        }
    }
</script>
</body>
</html>